# Сервис генерации чеков для сети ресторанов
Тестовое задание для компании SMENA

API сервис получает заказ, генерирует чеки для принтеров точки указанной в заказе, ставит асинхронные задачи на генерацию PDF-файлов для этих чеков.

###  Описание технологий:
- Python 3.9
- Django 3.2
- База данных - [PostgreSQL](https://hub.docker.com/_/postgres/) v9.6
- [django_rq](https://github.com/rq/django-rq) для асинронных задач
- [Redis](https://hub.docker.com/_/redis/) >= 3.0.0 как основа для django_rq
- Генерация pdf [wkhtmltopdf](https://hub.docker.com/r/openlabs/docker-wkhtmltopdf-aas/)

### API
Описание доступных методов находится в файле `api.yml` (swagger-спецификация).


## Запуск:
>**Важно!** Приложение работает только на Linux или через WLS. Ограничения связаны c работой django-rq.

1. Создать и запустить виртуальное окружение:
```bash
python -m venv venv
source venv/bin/activate
```
2. Установить зависимости:
```bash
pip install -r requirements.txt
```
3. Создайте файл .env в корне проекта на примере `.env.example` и заполните его строки.
4. Развернуть и запустить контейнеры с инфраструктурными приложениями перечисленные в `docker-compose.yml` командой
 ```bash
docker-compose up -d
```
5. Применить миграции:
```bash
python manage.py makemigrations
python manage.py migrate
```
6. Создать суперпользователя для доступа к админке:
```bash
python manage.py createsuperuser
```
7. Загрузить fixtures для с принтерами:
```bash
python manage.py loaddata printers.json
```
8. Запустить worker очереди RQ и оставить в рабочем состоянии
```bash
python manage.py rqworker default
```
9. Запустить приложение в другом окне терминала и оставить в рабочем состоянии
```bash
python manage.py runserver
```

### Схема работы сервиса

![][arch]

1. Сервис получает информацию о новом заказа, создаёт в БД чеки для всех принтеров точки указанной в заказе и ставит асинхронные задачи на генерацию PDF-файлов для этих чеков. Если у точки нет ни одного принтера - возвращает ошибку. Если чеки для данного заказа уже были созданы - возвращает ошибку.
2. Асинхронный воркер с помощью wkhtmltopdf генерируют PDF-файл из HTML-шаблон. Имя файла должно иметь следущий вид <ID заказа>\_<тип чека>.pdf (123456_client.pdf).
   Файлы должны хранится в папке media/pdf в корне проекта.
3. Приложение опрашивает сервис на наличие новых чеков. Опрос происходит по следующему пути: сначала запрашивается список чеков которые уже сгенерированы для конкретного принтера, после скачивается PDF-файл для каждого чека и отправляется на печать.

### Модели
<details> 
 <summary>Описание моделей Printer и Check </summary>
1. Принтер (Printer). Каждый принтер печатает только свой тип чеков. Поле api_key принимает уникальные значения, по нему
   однозначно определяется принтер. Для этой модели должны быть fixtures (принтеры для обоих типов чеков для нескольких точек).

| Поле       | Тип          | Значение        | Описание                          |
| ---------- | ------------ | --------------- | --------------------------------- |
| name       | CharField    |                 | название принтера                 |
| api_key    | CharField    |                 | ключ доступа к API                |
| check_type | CharField    | kitchen\|client | тип чека которые печатает принтер |
| point_id   | IntegerField |                 | точка к которой привязан принтер  |

2. Чек (Check). Информация о заказе для каждого чека хранится в JSON, нет необходимости делать отдельные модели.

| Поле       | Тип        | Значение               | Описание                     |
| ---------- | ---------- | ---------------------- | ---------------------------- |
| printer_id | ForeignKey |                        | принтер                      |
| type       | CharField  | kitchen\|client        | тип чека                     |
| order      | JSONField  |                        | информация о заказе          |
| status     | CharField  | new\|rendered\|printed | статус чека                  |
| pdf_file   | FileField  |                        | ссылка на созданный PDF-файл |

</details>


[arch]: images/arch.png